---
title: "Virginia Housing Trust Fund"
subtitle: "FY2014 - FY2024"
format:
  html:
    theme: flatly
    author: "Jonathan Knopf (jonathan@hdadvisors.net)"
execute: 
  echo: false
  warning: false
  freeze: auto
---

Setup

```{r}
#| label: setup
#| output: false

source("vhtf.R")

library(ggtext)

#setwd("C:/Users/Jonathan/Documents/repos/sandbox/vha/vhtf")

vhtf_raw <- read_csv("vhtf-projects-all.csv")

vhtf_sum <- read_csv("vhtf-summary.csv") |> 
  mutate(year = str_replace_all(year, "FY20", "FY"))

```

Load districts

```{r}
#| label: districts
#| eval: false

senate <- st_read("va_senate_2021.geojson", quiet = TRUE) |> 
  st_transform(4326)

senate$chamber <- "Senate"
senate$DISTRICT <- paste("SD", senate$DISTRICT)

house <- st_read("va_house_2021.geojson", quiet = TRUE) |> 
  st_transform(4326)

house$chamber <- "House"
house$DISTRICT <- paste("HD", house$DISTRICT)

districts <- bind_rows(senate, house) |> 
  select(chamber, district = DISTRICT, n = DISTRICTN) |> 
  arrange(chamber, n)

# Calculate minimum and maximum x and y values for each feature
districts$min_x <- sapply(st_geometry(districts), function(geom) {
  st_bbox(geom)[1]
})
districts$max_x <- sapply(st_geometry(districts), function(geom) {
  st_bbox(geom)[3]
})
districts$min_y <- sapply(st_geometry(districts), function(geom) {
  st_bbox(geom)[2]
})
districts$max_y <- sapply(st_geometry(districts), function(geom) {
  st_bbox(geom)[4]
})

write_rds(districts, "districts.rds")

```

Geocode VHTF projects

```{r}
#| label: geocode
#| eval: false

library(tidygeocoder)

vhtf_geocode <- vhtf_raw |> 
  
  geocode(
    address = project_address,
    method = 'geocodio'
  ) |> 
  
  # Specify WGS 1984 coordinate system for lat/long data
  
  st_as_sf(coords = c("long", "lat"),
           remove = FALSE,
           crs = 4326) 
  
  # Project into Virginia State Plane South
  
  #st_transform(4502)

vhtf_geocode$popup <- paste(
  sep = "<br/>",
  vhtf_geocode$project_name,
  vhtf_geocode$year,
  paste("Affordable units:", vhtf_geocode$units_affordable)
)

vhtf_districts <- vhtf_geocode |> 
  st_join(filter(select(districts, 1:2, 4), chamber == "House")) |> 
  st_join(filter(select(districts, 1:2, 4), chamber == "Senate")) |> 
  select(1:25, house = 27, senate = 29)

write_rds(vhtf_districts, "vhtf-districts.rds")

```

Annual allocations

```{r}
#| label: allocations

subtitle1 <- "Annual allocations for
  <span style='color:#0C4D4F'>**Loans**</span>,
  <span style='color:#A0D18E'>**Grants**</span>, and 
  <span style='color:#ECC51E'>**Administration** </span> 
  (FY2014 - FY2024)"

vhtf_sum |> 
  filter(data == "funding") |> 
  ggplot(aes(year, value, fill = type)) +
  geom_col() +
  scale_fill_vha(-1) +
  scale_y_continuous(
    breaks = seq(0, 80000000, 10000000),
    expand = c(0.01, 0.05),
    labels = label_dollar(accuracy = 1, scale = 0.000001, suffix = "MM")
    ) +
  add_zero_line() +
  labs(
    title = "Virginia Housing Trust Fund budget allocations",
    subtitle = subtitle1,
    caption = "**Source:** Virginia Department of Housing and Community Development."
  ) +
  theme_vha(base_size = 40)

ggsave("vhtf-annual-allocations.png", width = 8, height = 4.94, units = "in", bg = "white")

```

CLP units

```{r}
#| label: units

vhtf_raw |> 
  summarise(
    n = n(),
    units = sum(units_affordable),
    funding = sum(amt_vhtf),
    .by = year
  ) |> 
  arrange(year) |> 
  mutate(units = cumsum(units)) |> 
  ggplot(aes(year, units, label = label_comma()(units))) +
  geom_col(fill = "#0C4D4F") +
  geom_text(
    size = 12,
    color = "#0C4D4F",
    vjust = -0.5
  ) +
  scale_y_continuous(
    limits = c(0, 16500),
    breaks = seq(0, 15000, 5000),
    labels = label_comma(),
    expand = c(0.01, 0.05)
  ) +
  add_zero_line() +
  labs(
    title = "Affordable units produced by VHTF Competitive Loan Pool",
    subtitle = "Cumulative total of units affordable at 80% AMI or below (FY2014 - FY2023)",
    caption = "**Source:** Virginia Department of Housing and Community Development."
  ) +
  theme_vha(base_size = 40)

ggsave("vhtf-total-units.png", width = 8, height = 4.94, units = "in", bg = "white")

```

Total units by affordability and type

```{r}
#| label: units-type

vhtf_raw |> 
  summarise_at(
    vars(units_affordable:units_below80),
    sum,
    na.rm = TRUE
  ) |> 
  pivot_longer(
    everything(),
    names_to = "type",
    values_to = "units"
  ) |> 
  filter(type != "units_affordable") |> 
  mutate(
    type = case_match(
      type,
      "units_rehab" ~ "Rehabilitated",
      "units_psh" ~ "Permanent supportive housing",
      "units_below30" ~ "Affordable below 30% AMI",
      "units_below50" ~ "Affordable below 50% AMI",
      "units_below60" ~ "Affordable below 60% AMI",
      "units_below80" ~ "Affordable below 80% AMI"
    ),
    category = case_when(
      str_detect(type, "AMI") ~ "affordability",
      .default = "special"
    )
  ) |> 
  ggplot(aes(units, str_wrap(type, 14), fill = category, color = category, label = label_comma()(units))) +
  facet_grid(rows = vars(category), scales = "free_y", space = "free") +
  geom_col() +
  geom_text(
    size = 12,
    #color = "#0C4D4F",
    hjust = -0.3
  ) +
  scale_x_continuous(
    limits = c(0, 4000),
    expand = c(0.01, 0.05)
  ) +
  scale_fill_vha() +
  scale_color_vha() +
  add_zero_line("x") +
  labs(
    title = "Type of units produced by VHTF Competitive Loan Pool",
    subtitle = "Total number of units by affordability and type (FY2014 - FY2023)",
    caption = "**Source:** Virginia Department of Housing and Community Development.<br>**Note:** Unit totals are not mutually exclusive; for example, permanent supportive housing units are affordable at 30% AMI, and some are rehabilitated units."
  ) +
  theme_vha(base_size = 40) +
  theme(
    panel.grid.major.y = element_blank(),
    axis.text.x = element_blank(),
    strip.text = element_blank(),
    axis.text.y = element_text(
      lineheight = 0.3
    ),
    plot.caption = element_textbox_simple(
      lineheight = 0.4,
      margin = ggplot2::margin(t = 10)
    )
  )

library(ragg)

ggsave("vhtf-type-units.png", width = 8, height = 4.94, units = "in", bg = "white")

```

```{r}
#| label: demand

subtitle2 <- "Annual number of <span style='color:#A0D18E'>**applicants**</span> versus <span style='color:#0C4D4F'>**awards**</span> (FY2014 - FY2024)"

vhtf_sum |> 
  filter(
    data %in% c("applicants", "awardees"),
    year != "FY24"
    ) |> 
  summarise(
    n = sum(value),
    .by = c(year, type, data)
  ) |> 
  ggplot(aes(year, n, fill = data)) +
  facet_wrap(~type) +
  geom_col(position = "dodge") +
  scale_y_continuous(
    expand = c(0.01, 0.05)
  ) +
  scale_fill_vha(-1) +
  add_zero_line() +
  labs(
    title = "Demand for Virginia Housing Trust Fund funding",
    subtitle = subtitle2,
    caption = "**Source:** Virginia Department of Housing and Community Development.<br>**Note:** Incomplete data for total loan applicants and awards from FY2016 through FY2019."
  ) +
  theme_vha(base_size = 40) +
  theme(
    plot.caption = element_textbox_simple(
      lineheight = 0.4,
      margin = ggplot2::margin(t = 10)
    )
  )

ggsave("vhtf-demand.png", width = 8, height = 4.94, units = "in", bg = "white")

```

