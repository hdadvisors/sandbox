---
title: "Virginia Housing Trust Fund"
subtitle: "FY2014 - FY2024"
format:
  html:
    theme: flatly
    author: "Jonathan Knopf (jonathan@hdadvisors.net)"
execute: 
  echo: false
  warning: false
  freeze: auto
---

```{r}
#| label: setup
#| output: false

source("vhtf.R")

#setwd("C:/Users/Jonathan/Documents/repos/sandbox/vha/vhtf")

vhtf_raw <- read_csv("vhtf-projects-all.csv")

vhtf_sum <- read_csv("vhtf-summary.csv") |> 
  mutate(year = str_remove_all(year, "20"))

```

Some text

```{r}
#| label: geocode
#| eval: false

library(tidygeocoder)

vhtf_geocode <- vhtf_raw |> 
  
  geocode(
    address = project_address,
    method = 'geocodio'
  ) |> 
  
  # Specify WGS 1984 coordinate system for lat/long data
  
  st_as_sf(coords = c("long", "lat"),
           remove = FALSE,
           crs = 4326) |> 
  
  # Project into Virginia State Plane South
  
  st_transform(4502)

vhtf_geocode$popup <- paste(
  sep = "<br/>",
  vhtf_geocode$project_name,
  vhtf_geocode$year,
  paste("Affordable units:", vhtf_geocode$units_affordable)
)

write_rds(vhtf_geocode, "vhtf-geocode.rds")

```

```{r}
#| label: districts
#| eval: false

senate <- st_read("va_senate_2021.geojson", quiet = TRUE) |> 
  st_transform(4502)

senate$chamber <- "Senate"
senate$DISTRICT <- paste("SD", senate$DISTRICT)

house <- st_read("va_house_2021.geojson", quiet = TRUE) |> 
  st_transform(4502)

house$chamber <- "House"
house$DISTRICT <- paste("HD", house$DISTRICT)

districts <- bind_rows(senate, house) |> 
  select(chamber, district = DISTRICT, n = DISTRICTN) |> 
  arrange(chamber, n)

write_rds(districts, "districts.rds")

```



```{r}
#| label: allocations

subtitle <- "Annual allocations for
  <span style='color:#0C4D4F'>**Loans**</span>,
  <span style='color:#A0D18E'>**Grants**</span>, and 
  <span style='color:#ECC51E'>**Administration** </span> 
  (FY2014 - FY2024)"

vhtf_sum |> 
  filter(data == "funding") |> 
  ggplot(aes(year, value, fill = type)) +
  geom_col() +
  scale_fill_vha(-1) +
  scale_y_continuous(
    breaks = seq(0, 80000000, 10000000),
    expand = c(0.01, 0.05),
    labels = label_dollar(accuracy = 1, scale = 0.000001, suffix = "MM")
    ) +
  add_zero_line() +
  labs(
    title = "Virginia Housing Trust Fund budget allocations",
    subtitle = subtitle,
    caption = "**Source:** Virginia Department of Housing and Community Development."
  ) +
  theme_vha()

 ```

```{r}
#| eval: false

vhtf_sum |> 
  mutate(
    name = case_when(
      !name %in% c("Competitive Loan Pool", "Homelessness Reduction") ~ "Other",
      .default = name 
    )
  ) |> 
  filter(data == "funding", code != "admin") |> 
  ggplot(aes(year, value, fill = type)) +
  geom_col() +
  facet_wrap(~name) +
  scale_fill_vha(-1) +
  scale_x_discrete(
    breaks = c("FY2014", "FY2024")
  ) +
  scale_y_continuous(
    breaks = seq(0, 60000000, 10000000),
    expand = c(0.01, 0.05),
    labels = label_dollar(accuracy = 1, scale = 0.000001, suffix = "MM")
  ) +
  add_zero_line() +
  labs(
    title = "Virginia Housing Trust Fund budget allocations",
    subtitle = subtitle,
    caption = "**Source:** Virginia Department of Housing and Community Development."
  ) +
  theme_vha()


vhtf_annual <- vhtf_raw |> 
  summarise(
    n = n(),
    units = sum(units_affordable),
    funding = sum(amt_vhtf),
    .by = year
  )

```

