---
title: "hdatools base size issue"
date: "`r Sys.Date()`"
format:
#  pdf: default
  html: 
    self-contained: true
editor: visual
execute: 
  warning: false
---

Loading `hdatools` package generates base size error for plots when rendered as HTML. Default font base size creates text that is scaled well below readability level. Error occurs even when plots are made without using `hdatools` functions.

Issue appears to trace back to `showtext::showtext_auto()` being called when the package loads.

## Setup

```{r}

library(tidyverse)
library(tidycensus)
library(scales)
library(hdatools)
library(ggtext)

```

```{r}

rva_inc <- get_acs(
  geography = "county",
  state = "Virginia",
  county = c("Richmond city", "Chesterfield County", "Henrico County"),
  variables = "B19013_001",
  year = 2021
) |> 
  mutate(NAME = str_remove(NAME, ", Virginia"))

```

## Example 1

Basic plot using functions from `hdatools`. The default `theme_hda()` base size is 14.

The default line height for `plot.caption` (1.1) is also not respected.

```{r}

ggplot(rva_inc, aes(x = estimate, y = reorder(NAME, estimate), fill = NAME)) +
  geom_col() +
  scale_fill_hda() +
  scale_x_continuous(labels = label_dollar()) +
  theme_hda() +
  flip_gridlines() +
  labs(
    title = "Median household income",
    subtitle = "Richmond-area localities",
    caption = "**Source:** American Community Survey, 2017-2021 5-year estimates.<br>**Note:** Incomes adjusted to 2021 dollars."
  )

```

## Example 2

Base size adjusted to proper scale. Line height error not resolved.

```{r}

ggplot(rva_inc, aes(x = estimate, y = reorder(NAME, estimate), fill = NAME)) +
  geom_col() +
  scale_fill_hda() +
  scale_x_continuous(labels = label_dollar()) +
  theme_hda(base_size = 24) +
  flip_gridlines() +
  labs(
    title = "Median household income",
    subtitle = "Richmond-area localities",
    caption = "**Source:** American Community Survey, 2017-2021 5-year estimates.<br>**Note:** Incomes adjusted to 2021 dollars."
  )

```

## Example 3

No `hdatools` functions used; base ggplot themes only.

```{r}

ggplot(rva_inc, aes(x = estimate, y = reorder(NAME, estimate), fill = NAME)) +
  geom_col() +
#  scale_fill_hda() +
  scale_x_continuous(labels = label_dollar()) +
#  theme_hda() +
#  flip_gridlines() +
  labs(
    title = "Median household income",
    subtitle = "Richmond-area localities",
    caption = "Source: American Community Survey, 2017-2021 5-year estimates.\nNote: Incomes adjusted to 2021 dollars."
  )

```

## Example 4

Error is resolved when `showtext::showtext_opts()` is manually used to set the DPI.

```{r}

# Sweet spot seems to be 200 DPI and base size of 10
# This setting also works well in PDF export

showtext::showtext_opts(dpi = 200)

ggplot(rva_inc, aes(x = estimate, y = reorder(NAME, estimate), fill = NAME)) +
  geom_col() +
  scale_fill_hda() +
  scale_x_continuous(labels = label_dollar()) +
  theme_hda(base_size = 10) +
  flip_gridlines() +
  labs(
    title = "Median household income",
    subtitle = "Richmond-area localities",
    caption = "**Source:** American Community Survey, 2017-2021 5-year estimates.<br>**Note:** Incomes adjusted to 2021 dollars."
  )

```
